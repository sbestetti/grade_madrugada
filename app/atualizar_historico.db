-- Stored procedure que atualiza a tabela de historico com dados novos e limpa a tabela de registros
DELIMITER //

CREATE PROCEDURE atualizar_historico()

BEGIN
  
  SET SESSION internal_tmp_mem_storage_engine=Memory;
  
  DELETE FROM sumario WHERE data <= DATE(NOW()) - INTERVAL 15 DAY;
  
  CREATE TABLE tmp_sumario AS
    SELECT
      r.data,
      p.nome,
      r.codigo_de_erro,
      e.descricao,
      COUNT(*) AS total
    FROM
      registros AS r
      LEFT JOIN participantes AS p ON r.cnpj = p.cnpj
      LEFT JOIN erros AS e ON r.codigo_de_erro = e.codigo_de_erro
    WHERE
      r.data >= DATE(NOW())
    GROUP BY
      r.data,
      p.nome,
      r.codigo_de_erro;
  
  DELETE FROM sumario WHERE data = DATE(NOW());
  
  INSERT INTO
    sumario (
      data,
      nome,
      codigo_de_erro,
      descricao,
      total
    )
  SELECT * FROM tmp_sumario;
  
  UPDATE 
        ultima_atualizacao
      SET
        horario = NOW()
      WHERE 
        tabela = 'sumario';
  
  DROP TABLE tmp_sumario;
  
END //
