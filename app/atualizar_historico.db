-- Stored procedure que atualiza a tabela de historico com dados novos e limpa a tabela de registros
DELIMITER //

CREATE PROCEDURE atualizar_historico()

BEGIN

    set session internal_tmp_mem_storage_engine=Memory;

    DELETE FROM historico WHERE data >= DATE(NOW());

    INSERT INTO historico
        SELECT 
            registros.data,
            participantes.nome,
            COUNT(*) AS total 
    FROM 
        registros
    JOIN 
        participantes ON registros.cnpj = participantes.cnpj
    WHERE 
        data >= DATE(NOW())
    GROUP BY 
        registros.data,
        participantes.nome;

    TRUNCATE TABLE registros;

END //
